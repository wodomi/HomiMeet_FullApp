{% extends 'base.html' %}
{% block title %}Discover ETA{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>ğŸ“ Discover ETA</h2>

  <!-- MODE SELECTION -->
  <div class="text-center mb-4">
    <button class="btn btn-outline-primary me-2" onclick="switchMode('haversine')">ğŸ§­ Haversine Mode</button>
    <button class="btn btn-outline-success" onclick="switchMode('google')">ğŸ—ºï¸ Google Maps Mode</button>
  </div>

  <!-- ========== Haversine Mode ========== -->
  <div id="haversine_mode">
    <div class="mb-3">
      <input type="text" id="placeInput" class="form-control" placeholder="Search place (e.g. Timoga)">
      <button class="btn btn-primary mt-2" onclick="searchPlace()">Search</button>
    </div>

    <label>Destination Coordinates:</label>
    <input type="text" id="destination" class="form-control mb-2" readonly>

    <button class="btn btn-success" onclick="getETA()">Get ETA</button>
    <p id="eta_result" class="mt-3">ETA will appear here...</p>

    <iframe
      id="mapFrame"
      width="100%" height="400" style="border:0;" allowfullscreen loading="lazy"
      referrerpolicy="no-referrer-when-downgrade"
      src="https://maps.google.com/maps?q=Iligan&t=&z=13&ie=UTF8&iwloc=&output=embed">
    </iframe>
  </div>

  <!-- ========== Google Maps Mode ========== -->
  <div id="google_mode" style="display:none">
    <input id="google_destination" class="form-control mb-2" type="text" placeholder="Enter destination name or address">
    <button class="btn btn-success mb-2" onclick="routeWithGoogle()">Get Google ETA</button>
    <div id="googleMap" style="height: 400px;" class="border rounded"></div>
    <p id="google_eta_result" class="mt-2">ETA will appear here...</p>
  </div>
</div>

<!-- Google Maps API (always loaded, dev mode ok) -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&libraries=places"></script>

<script>
function switchMode(mode) {
  document.getElementById('haversine_mode').style.display = (mode === 'haversine') ? 'block' : 'none';
  document.getElementById('google_mode').style.display = (mode === 'google') ? 'block' : 'none';
}

// ====================== Haversine System ======================
function searchPlace() {
  const place = document.getElementById("placeInput").value;
  if (!place) return alert("Enter a place name.");
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`)
    .then(res => res.json())
    .then(data => {
      if (data.length === 0) return alert("No results found.");
      const lat = data[0].lat;
      const lon = data[0].lon;
      document.getElementById("destination").value = `${lat},${lon}`;
      document.getElementById("mapFrame").src = `https://maps.google.com/maps?q=${lat},${lon}&z=15&output=embed`;
    });
}

function getETA() {
  const dest = document.getElementById("destination").value;
  if (!dest.includes(',')) return alert("Destination must be lat,lng");

  navigator.geolocation.getCurrentPosition(pos => {
    fetch("/get_eta", {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        destination: dest
      })
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById("eta_result").innerText = "ETA: " + data.eta;
    });
  }, err => {
    alert("Location permission denied.");
  });
}

// ====================== Google Maps System ======================
let map, directionsService, directionsRenderer;

function initGoogleMap() {
  map = new google.maps.Map(document.getElementById("googleMap"), {
    zoom: 13,
    center: { lat: 8.228, lng: 124.245 }
  });
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map });
}

function routeWithGoogle() {
  navigator.geolocation.getCurrentPosition(pos => {
    const origin = {
      lat: pos.coords.latitude,
      lng: pos.coords.longitude
    };
    const destination = document.getElementById("google_destination").value;

    directionsService.route({
      origin,
      destination,
      travelMode: google.maps.TravelMode.DRIVING
    }, (response, status) => {
      if (status === "OK") {
        directionsRenderer.setDirections(response);
        const duration = response.routes[0].legs[0].duration.text;
        document.getElementById("google_eta_result").innerText = "ETA: " + duration;
      } else {
        alert("Google Maps failed: " + status);
      }
    });
  });
}

// Init Google map on page load
window.onload = function () {
  initGoogleMap();
};
</script>
{% endblock %}
