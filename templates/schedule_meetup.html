{% extends 'base.html' %}
{% block title %}Schedule Meetup{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2>üìç Schedule a Meetup</h2>

  <form method="POST">
    <div class="mb-3">
      <label>Group ID</label>
      <input class="form-control" name="group_id" required>
    </div>

    <div class="mb-3">
      <label>Search Location</label>
      <input id="autocomplete" class="form-control" type="text" placeholder="e.g. Buru-un Beach" />
    </div>

    <div id="map" style="height: 400px;" class="mb-3 rounded border"></div>

    <input type="hidden" name="location" id="location_field">
    <input type="hidden" name="lat" id="lat_field">
    <input type="hidden" name="lng" id="lng_field">

    <div class="mb-3">
      <label>Time (YYYY-MM-DD HH:MM:SS)</label>
      <input class="form-control" name="scheduled_time" required>
    </div>

    <button class="btn btn-primary" type="submit">Schedule</button>
  </form>
</div>

<script>
let map, marker, selectedLatLng;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 8.25, lng: 124.25 },
    zoom: 13
  });

  marker = new google.maps.Marker({ map, draggable: true });

  map.addListener("click", function (e) {
    selectedLatLng = e.latLng;
    marker.setPosition(e.latLng);
    updateFields();
  });

  marker.addListener("dragend", function () {
    selectedLatLng = marker.getPosition();
    updateFields();
  });

  const input = document.getElementById("autocomplete");
  const autocomplete = new google.maps.places.Autocomplete(input);
  autocomplete.bindTo("bounds", map);

  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place.geometry) return;
    map.setCenter(place.geometry.location);
    map.setZoom(15);
    marker.setPosition(place.geometry.location);
    selectedLatLng = place.geometry.location;
    updateFields(place);
  });
}

function updateFields(place = null) {
  const loc = place?.formatted_address || document.getElementById("autocomplete").value;
  document.getElementById("location_field").value = loc;
  document.getElementById("lat_field").value = selectedLatLng.lat();
  document.getElementById("lng_field").value = selectedLatLng.lng();
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&libraries=places&callback=initMap" async defer></script>
{% endblock %}
