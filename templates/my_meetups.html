{% extends 'base.html' %}
{% block title %}My Meetups{% endblock %}

{% block head %}
<style>
/* Wrapper & header */
.meetups-wrapper { max-width:1100px; margin: 1.5rem auto; padding:0 1rem; }
.meetups-header { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom:1rem; }
.meetups-header h2 { margin:0; font-weight:700; }

/* Container card using theme */
.meetups-card { padding:1rem; border-radius:12px; }

/* Visual row style (accordion-like) */
.meetup-row {
  display:block;
  border-radius:10px;
  margin-bottom:.9rem;
  box-shadow: var(--elev);
  border: 1px solid rgba(0,0,0,0.04);
  background: linear-gradient(180deg, var(--surface), var(--surface-2));
  overflow:visible;
}

/* Toggle header */
.meetup-toggle {
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:1rem;
  padding:.9rem 1rem;
  background: transparent;
  border: none;
  text-align:left;
  cursor:pointer;
}
.meetup-toggle:focus { outline: 2px solid rgba(13,148,214,0.16); outline-offset:2px; border-radius:10px; }

/* Title & subtitle */
.meetup-title { min-width:0; }
.meetup-title strong { display:block; font-size:1rem; color:var(--text); }
.meetup-sub { font-size:.92rem; color:var(--muted); margin-top:.18rem; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; max-width:52ch; }

/* Date badge area */
.meetup-date { text-align:right; min-width:10ch; }
.meetup-date .badge { font-weight:700; padding:.45rem .6rem; border-radius:.7rem; font-size:.88rem; }

/* Today's highlight */
.meetup-today { box-shadow: 0 6px 20px rgba(43,180,255,0.06); border-left: 4px solid var(--accent); }

/* Animated body */
.meetup-body {
  overflow: hidden;
  height: 0;            /* collapsed by default */
  transition: none;     /* animation performed by JS */
  will-change: height;
  padding: 0 1rem;      /* horizontal padding preserved */
  background: linear-gradient(180deg, var(--surface), var(--surface-2));
  border-top: 1px solid rgba(0,0,0,0.03);
  border-bottom-left-radius:10px;
  border-bottom-right-radius:10px;
}

/* Inner content inside the body */
.meetup-body-inner {
  padding: .9rem 0;     /* vertical padding; horizontal handled by parent */
}

/* Member list */
.members-list .member-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:1rem;
  padding:.6rem;
  border-radius:8px;
  margin-bottom:.45rem;
  background: linear-gradient(180deg, var(--surface), var(--surface-2));
  border: 1px solid rgba(0,0,0,0.03);
}

/* Map */
.meetup-map { width:100%; height:280px; border-radius:8px; overflow:hidden; margin-bottom:.6rem; border:1px solid rgba(0,0,0,0.04); }

/* CTA row */
.meetup-ctas { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem; }

/* small screens */
@media (max-width:720px) {
  .meetup-head { flex-direction:column; align-items:flex-start; gap:.5rem; }
  .meetup-map { height:200px; }
  .meetup-date { text-align:left; margin-top:.4rem; }
}
</style>
{% endblock %}

{% block content %}
<div class="meetups-wrapper">
  <div class="meetups-header">
    <h2>üìÖ My Meetups</h2>
    <div class="muted">Manage upcoming events</div>
  </div>

  {% if meetups %}
    {# --- robust sort: put timed meetups first (sorted), untimed at the end --- #}
    {% set timed = meetups | selectattr('scheduled_time') | list %}
    {% set timed = timed | sort(attribute='scheduled_time') %}
    {% set untimed = meetups | rejectattr('scheduled_time') | list %}
    {% set sorted_meetups = timed + untimed %}

    {# --- find first upcoming index (works if now is 'YYYY-MM-DD' or 'YYYY-MM-DD HH:MM') --- #}
    {% set ns = namespace(upcoming_index=None) %}
    {% set now_len = now|default('')|length %}
    {% for m in sorted_meetups %}
      {% if m.scheduled_time %}
        {% if now_len > 10 %}
          {% if m.scheduled_time.strftime('%Y-%m-%d %H:%M') >= now and ns.upcoming_index is none %}
            {% set ns.upcoming_index = loop.index0 %}
          {% endif %}
        {% else %}
          {% if m.scheduled_time.strftime('%Y-%m-%d') >= now and ns.upcoming_index is none %}
            {% set ns.upcoming_index = loop.index0 %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}

    <div class="card-theme meetups-card" id="meetupAccordion" data-single="true">
      {% for meetup in sorted_meetups %}
        {% set idx = loop.index0 %}
        {% set is_today = meetup.scheduled_time and (meetup.scheduled_time.strftime('%Y-%m-%d') == (now[:10] if now is defined else '')) %}
        {% set should_open = ns.upcoming_index is not none and idx == ns.upcoming_index %}

        <div class="meetup-row" id="meetup-row-{{ meetup.id }}" data-meetup-index="{{ idx }}">
          <div class="d-flex meetup-toggle meetup-head" role="button"
               aria-expanded="{{ 'true' if should_open else 'false' }}"
               aria-controls="meetup-body-{{ meetup.id }}"
               data-target="#meetup-body-{{ meetup.id }}">
            <div class="meetup-title">
              <strong>{{ meetup.location or meetup.title or 'Untitled Meetup' }}</strong>
              {% if meetup.description %}
                <div class="meetup-sub">{{ meetup.description }}</div>
              {% endif %}
            </div>

            <div class="meetup-date text-end">
              {% if meetup.scheduled_time %}
                <div><span class="badge {% if is_today %}badge-today{% else %}bg-primary{% endif %}">
                  {{ meetup.scheduled_time.strftime('%b %d, %Y %I:%M %p') }}
                </span></div>
                {% if is_today %}<div class="muted small">Today</div>{% endif %}
              {% else %}
                <div><span class="badge bg-secondary">TBD</span></div>
              {% endif %}
            </div>
          </div>

          <div id="meetup-body-{{ meetup.id }}" class="meetup-body" aria-hidden="{{ 'false' if should_open else 'true' }}">
            <div class="meetup-body-inner">
              {% if meetup.lat is defined and meetup.lng is defined and meetup.lat and meetup.lng %}
                <div class="meetup-map" aria-hidden="false">
                  <iframe width="100%" height="100%" loading="lazy"
                          src="https://www.google.com/maps?q={{ meetup.lat }},{{ meetup.lng }}&z=14&output=embed"
                          title="Map for {{ meetup.location or meetup.title }}"></iframe>
                </div>
              {% endif %}

              <p class="mb-2"><strong>Description:</strong> {{ meetup.description or "No description provided." }}</p>

              <hr>

              <h6 class="mb-2">üë• Members</h6>
              <ul class="members-list list-unstyled mb-3">
                {% if meetup.creator %}
                  <li class="member-item">
                    <div>
                      <strong>{{ meetup.creator }}</strong> <small class="muted">‚Äî Host</small>
                      {% if meetup.creator == current_user.username %}<span class="you-badge ms-2">You</span>{% endif %}
                    </div>
                    {% if is_today and meetup.get('host_eta') %}<div><span class="badge bg-info">ETA: {{ meetup.host_eta }}</span></div>{% endif %}
                  </li>
                {% endif %}

                {% if meetup.members %}
                  {% for member in meetup.members %}
                    {% set is_host_duplicate = meetup.creator and member.name == meetup.creator %}
                    {% if not is_host_duplicate %}
                      <li class="member-item">
                        <div>
                          <div><strong>{{ member.name }}</strong> {% if member.status %}<small class="muted"> ‚Äî {{ member.status }}</small>{% endif %}</div>
                          {% if member.name == current_user.username %}<div class="mt-1"><span class="you-badge">You</span></div>{% endif %}
                        </div>

                        <div class="d-flex align-items-center gap-2">
                          {% if is_today %}
                            {% if member.eta %}<span class="badge bg-info">ETA: {{ member.eta }}</span>{% else %}<span class="badge bg-secondary">No ETA</span>{% endif %}
                          {% endif %}

                          {% if meetup.is_owner and member.id and member.id|string != current_user.id|string %}
                            <form method="POST" action="{{ url_for('kick_user') }}" onsubmit="return confirm('Remove this member from the meetup?');">
                              <input type="hidden" name="meetup_id" value="{{ meetup.id }}">
                              <input type="hidden" name="user_id" value="{{ member.id }}">
                              <button type="submit" class="btn btn-sm btn-outline-danger">Kick</button>
                            </form>
                          {% endif %}
                        </div>
                      </li>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <li class="member-item muted">No members yet.</li>
                {% endif %}
              </ul>

              {% if meetup.is_owner %}
                <div class="meetup-ctas">
                  <a href="{{ url_for('schedule_meetup', meetup_id=meetup.id) }}" class="btn btn-outline-secondary btn-sm">‚úèÔ∏è Reschedule</a>

                  <form method="POST" action="{{ url_for('delete_meetup') }}" onsubmit="return confirm('Are you sure you want to delete this meetup? This cannot be undone.');" style="display:inline;">
                    <input type="hidden" name="meetup_id" value="{{ meetup.id }}">
                    <button type="submit" class="btn btn-outline-danger btn-sm">üóë Delete</button>
                  </form>

                  {% if meetup.lat is defined and meetup.lng is defined and meetup.lat and meetup.lng %}
                    <button type="button" class="btn btn-outline-primary btn-sm view-map-btn"
                            data-lat="{{ meetup.lat }}" data-lng="{{ meetup.lng }}" data-location="{{ meetup.location|e }}">üó∫Ô∏è View Map</button>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

  {% else %}
    <div class="alert alert-info mt-3 card-theme">You have no upcoming meetups.</div>
  {% endif %}
</div>

<!-- fullscreen map modal -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down modal-xl modal-dialog-centered">
    <div class="modal-content card-theme">
      <div class="modal-header">
        <h5 class="modal-title" id="mapModalTitle">Map</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <iframe id="mapModalIframe" class="modal-map-iframe" src="" title="Map preview" loading="lazy"></iframe>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
  (function () {
    /* Smooth accordion open/close with easing (same script as before) */
    function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }
    function animate({duration, timingFn, onUpdate, onComplete}) {
      const start = performance.now();
      let rafId = null;
      function frame(now) {
        const elapsed = Math.min(duration, now - start);
        const progress = duration === 0 ? 1 : (elapsed / duration);
        const eased = timingFn(progress);
        onUpdate(eased);
        if (elapsed < duration) {
          rafId = requestAnimationFrame(frame);
        } else {
          onComplete && onComplete();
        }
      }
      rafId = requestAnimationFrame(frame);
      return () => { if (rafId) cancelAnimationFrame(rafId); };
    }

    function expandBody(bodyEl, cb) {
      if (!bodyEl) return;
      bodyEl.style.display = 'block';
      const prev = bodyEl.style.height;
      bodyEl.style.height = 'auto';
      const targetHeight = bodyEl.scrollHeight;
      bodyEl.style.height = prev;
      bodyEl.setAttribute('aria-hidden','false');
      const duration = Math.min(420, Math.max(200, targetHeight * 0.6));
      animate({
        duration,
        timingFn: easeOutCubic,
        onUpdate: (t) => { bodyEl.style.height = (targetHeight * t) + 'px'; },
        onComplete: () => { bodyEl.style.height = 'auto'; cb && cb(); }
      });
    }

    function collapseBody(bodyEl, cb) {
      if (!bodyEl) return;
      const startHeight = bodyEl.scrollHeight;
      const duration = Math.min(360, Math.max(180, startHeight * 0.5));
      bodyEl.style.height = startHeight + 'px';
      bodyEl.setAttribute('aria-hidden','true');
      animate({
        duration,
        timingFn: (t) => 1 - Math.pow(1 - t, 3),
        onUpdate: (tt) => { const value = startHeight * (1 - tt); bodyEl.style.height = value + 'px'; },
        onComplete: () => { bodyEl.style.height = '0px'; bodyEl.style.display = ''; cb && cb(); }
      });
    }

    function closeOtherBodies(parentEl, exceptEl) {
      const single = parentEl && parentEl.dataset && parentEl.dataset.single === 'true';
      if (!single) return;
      const bodies = parentEl.querySelectorAll('.meetup-body');
      bodies.forEach(b => {
        if (b === exceptEl) return;
        if (b.getAttribute('aria-hidden') === 'false') {
          collapseBody(b);
          const toggle = parentEl.querySelector('[data-target="#' + b.id + '"]');
          if (toggle) toggle.setAttribute('aria-expanded','false');
        }
      });
    }

    function getNavHeight() {
      const nav = document.querySelector('.navbar');
      return nav ? nav.offsetHeight : 0;
    }

    function scrollRowIntoView(rowEl) {
      if (!rowEl) return;
      const navH = getNavHeight();
      const gap = 12;
      const rect = rowEl.getBoundingClientRect();
      const targetY = window.scrollY + rect.top - navH - gap;
      window.scrollTo({ top: Math.max(0, Math.floor(targetY)), behavior: 'smooth' });
    }

    document.addEventListener('DOMContentLoaded', function () {
      const Accordion = document.getElementById('meetupAccordion');
      const toggles = document.querySelectorAll('.meetup-toggle');

      document.querySelectorAll('.meetup-body').forEach(body => {
        const hidden = body.getAttribute('aria-hidden') === 'true';
        if (hidden) { body.style.height = '0px'; body.style.display = ''; }
        else { body.style.display = 'block'; body.style.height = 'auto'; }
      });

      toggles.forEach(toggle => {
        toggle.addEventListener('click', function (e) {
          const targetSelector = this.dataset.target;
          if (!targetSelector) return;
          const body = document.querySelector(targetSelector);
          if (!body) return;
          const parent = Accordion;
          const isOpen = body.getAttribute('aria-hidden') === 'false';
          if (!isOpen) {
            closeOtherBodies(parent, body);
            expandBody(body, () => {
              this.setAttribute('aria-expanded','true');
              body.setAttribute('aria-hidden','false');
              const focusable = body.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
              if (focusable) try { focusable.focus({ preventScroll: true }); } catch(e){}
            });
            const row = this.closest('.meetup-row');
            setTimeout(() => scrollRowIntoView(row), 160);
            this.setAttribute('aria-expanded','true');
          } else {
            collapseBody(body, () => { this.setAttribute('aria-expanded','false'); });
            this.setAttribute('aria-expanded','false');
          }
        });

        toggle.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault(); this.click();
          }
        });
      });

      const autoOpenToggle = Array.from(toggles).find(t => t.getAttribute('aria-expanded') === 'true');
      if (autoOpenToggle) {
        const targetSel = autoOpenToggle.dataset.target;
        const targetBody = document.querySelector(targetSel);
        if (targetBody) {
          expandBody(targetBody, () => {
            const row = autoOpenToggle.closest('.meetup-row');
            setTimeout(() => scrollRowIntoView(row), 120);
          });
        }
      }

      const mapModalEl = document.getElementById('mapModal');
      const mapModalIframe = document.getElementById('mapModalIframe');
      const mapModalTitle = document.getElementById('mapModalTitle');
      let mapModal = mapModalEl ? new bootstrap.Modal(mapModalEl) : null;

      document.querySelectorAll('.view-map-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const lat = this.dataset.lat;
          const lng = this.dataset.lng;
          const loc = this.dataset.location || 'Map';
          if (!lat || !lng) return;
          const url = `https://www.google.com/maps?q=${encodeURIComponent(lat)},${encodeURIComponent(lng)}&z=15&output=embed`;
          if (mapModalIframe) mapModalIframe.src = url;
          if (mapModalTitle) mapModalTitle.textContent = `Map ‚Äî ${loc}`;
          if (mapModal) mapModal.show();
        });
      });

      if (mapModalEl) {
        mapModalEl.addEventListener('hidden.bs.modal', function () {
          if (mapModalIframe) mapModalIframe.src = '';
        });
      }
    });
  })();
  </script>
{% endblock %}
